on:
  workflow_run:
    workflows:
      - Build & Test
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: deploy-frontend-staging
  cancel-in-progress: true

env:
  # Some tooling expects GITHUB_TOKEN via env var.
  GITHUB_TOKEN: ${{ github.token }}
jobs:
  deploy:
    name: Build and Deploy to S3 (staging)
    runs-on: ubuntu-latest
    environment: staging
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
      AWS_REGION: ${{ secrets.AWS_REGION || vars.AWS_REGION }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || vars.AWS_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET || vars.S3_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID || vars.CLOUDFRONT_DISTRIBUTION_ID }}

    if: >-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'staging'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}
          submodules: recursive

      - name: Setup Mise
        uses: jdx/mise-action@c37c93293d6b742fc901e1406b8f764f6fb19dac # v2.4.4
        with:
          github_token: ${{ github.token }}
          version: 2025.10.11
          sha256:
            ${{ runner.os == 'Linux' && runner.arch == 'X64' && '589cac941160e404d13be6f5699a25ffdb25b732084430338bc384df9f0a4438' ||
            runner.os == 'Linux' && runner.arch == 'ARM64' && '4f9cb0ad59bd8d118f58812fc8baa3c09a732d01e10c650d49c6d0910b77e24d' ||
            runner.os == 'macOS' && runner.arch == 'ARM64' && 'ece0e7d3f50240fcdd562c3f4e2263596ba9162444e439617103c4a73a12409b' }}

      - name: Install dependencies
        run: mise install:frozen

      - name: Build dependencies
        run: mise build:deps

      - name: Copy assets
        run: pnpm --filter client exec node scripts/copyAssets.mjs

      - name: Build staging frontend
        env:
          VITE_EMOJI_URL: https://static.stoat.chat/emoji
        run: pnpm --filter client exec vite build

      - name: Configure AWS credentials
        run: |
          test -n "${AWS_ACCESS_KEY_ID}" || { echo "Missing AWS_ACCESS_KEY_ID"; exit 1; }
          test -n "${AWS_SECRET_ACCESS_KEY}" || { echo "Missing AWS_SECRET_ACCESS_KEY"; exit 1; }
          test -n "${AWS_REGION}" || { echo "Missing AWS_REGION (set secret AWS_REGION or variable AWS_REGION)"; exit 1; }
          aws sts get-caller-identity >/dev/null

      - name: Deploy static assets to S3
        run: |
          test -n "${S3_BUCKET}" || { echo "Missing S3_BUCKET (set secret/variable S3_BUCKET)"; exit 1; }
          aws s3 sync packages/client/dist/ "s3://${S3_BUCKET}/" \
            --delete \
            --cache-control "max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "*.json" \
            --exclude "*.txt"

      - name: Upload index.html with no-cache
        run: |
          aws s3 cp packages/client/dist/index.html "s3://${S3_BUCKET}/index.html" \
            --cache-control "no-cache,no-store,must-revalidate"

      - name: Upload manifest/text files with no-cache
        run: |
          shopt -s nullglob
          for f in packages/client/dist/*.json packages/client/dist/*.txt; do
            aws s3 cp "$f" "s3://${S3_BUCKET}/$(basename "$f")" \
              --cache-control "no-cache,no-store,must-revalidate"
          done

      - name: Invalidate CloudFront cache
        run: |
          test -n "${CLOUDFRONT_DISTRIBUTION_ID}" || { echo "Missing CLOUDFRONT_DISTRIBUTION_ID (set secret/variable CLOUDFRONT_DISTRIBUTION_ID)"; exit 1; }
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DISTRIBUTION_ID}" \
            --paths "/*"
