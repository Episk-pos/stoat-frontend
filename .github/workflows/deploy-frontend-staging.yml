
on:
  push:
    branches:
      - staging
  workflow_run:
    workflows:
      - Build & Test
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: deploy-frontend-staging
  cancel-in-progress: true

jobs:
  deploy:
    name: Build and Deploy to S3 (staging)
    runs-on: ubuntu-latest
    environment: staging
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
      AWS_REGION: ${{ secrets.AWS_REGION || vars.AWS_REGION }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || vars.AWS_REGION }}
      S3_BUCKET: ${{ secrets.S3_BUCKET || vars.S3_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID || vars.CLOUDFRONT_DISTRIBUTION_ID }}

    if: >-
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'staging'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.workflow_run.head_sha }}
          submodules: recursive

      - name: Setup Mise
        uses: immich-app/devtools/actions/use-mise@cd24790a7f5f6439ac32cc94f5523cb2de8bfa8c # use-mise-action-v1.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: mise install:frozen

      - name: Build dependencies
        run: mise build:deps

      - name: Copy assets
        run: pnpm --filter client exec node scripts/copyAssets.mjs

      - name: Build staging frontend
        env:
          VITE_API_URL: https://staging.stoat.episkopos.community/api
          VITE_WS_URL: wss://staging.stoat.episkopos.community/events
          VITE_MEDIA_URL: https://staging.stoat.episkopos.community/autumn
          VITE_PROXY_URL: https://staging.stoat.episkopos.community/january
          VITE_EMOJI_URL: https://static.stoat.chat/emoji
          VITE_GIF_API_URL: https://staging.stoat.episkopos.community/gifbox
        run: pnpm --filter client exec vite build

      - name: Configure AWS credentials
        run: |
          test -n "${AWS_ACCESS_KEY_ID}" || { echo "Missing AWS_ACCESS_KEY_ID"; exit 1; }
          test -n "${AWS_SECRET_ACCESS_KEY}" || { echo "Missing AWS_SECRET_ACCESS_KEY"; exit 1; }
          test -n "${AWS_REGION}" || { echo "Missing AWS_REGION (set secret AWS_REGION or variable AWS_REGION)"; exit 1; }
          aws sts get-caller-identity >/dev/null

      - name: Deploy static assets to S3
        run: |
          test -n "${S3_BUCKET}" || { echo "Missing S3_BUCKET (set secret/variable S3_BUCKET)"; exit 1; }
          aws s3 sync packages/client/dist/ "s3://${S3_BUCKET}/" \
            --delete \
            --cache-control "max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "*.json" \
            --exclude "*.txt"

      - name: Upload index.html with no-cache
        run: |
          aws s3 cp packages/client/dist/index.html "s3://${S3_BUCKET}/index.html" \
            --cache-control "no-cache,no-store,must-revalidate"

      - name: Upload manifest/text files with no-cache
        run: |
          shopt -s nullglob
          for f in packages/client/dist/*.json packages/client/dist/*.txt; do
            aws s3 cp "$f" "s3://${S3_BUCKET}/$(basename "$f")" \
              --cache-control "no-cache,no-store,must-revalidate"
          done

      - name: Invalidate CloudFront cache
        run: |
          test -n "${CLOUDFRONT_DISTRIBUTION_ID}" || { echo "Missing CLOUDFRONT_DISTRIBUTION_ID (set secret/variable CLOUDFRONT_DISTRIBUTION_ID)"; exit 1; }
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DISTRIBUTION_ID}" \
            --paths "/*"
