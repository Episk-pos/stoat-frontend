name: Deploy Frontend

on:
  workflow_run:
    workflows:
      - Build & Test
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: deploy-frontend-main
  cancel-in-progress: true

jobs:
  deploy:
    name: Build and Deploy to S3
    runs-on: ubuntu-latest

    if: >-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      )

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.event.workflow_run.head_sha }}
          submodules: recursive

      - name: Setup Mise
        uses: immich-app/devtools/actions/use-mise@cd24790a7f5f6439ac32cc94f5523cb2de8bfa8c # use-mise-action-v1.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: mise install:frozen

      - name: Build dependencies
        run: mise build:deps

      - name: Copy assets
        run: pnpm --filter client exec node scripts/copyAssets.mjs

      - name: Build production frontend
        env:
          VITE_API_URL: https://stoat.episkopos.community/api
          VITE_WS_URL: wss://stoat.episkopos.community/events
          VITE_MEDIA_URL: https://stoat.episkopos.community/autumn
          VITE_PROXY_URL: https://stoat.episkopos.community/january
          VITE_EMOJI_URL: https://static.stoat.chat/emoji
          VITE_GIF_API_URL: https://stoat.episkopos.community/gifbox
        run: pnpm --filter client exec vite build

      - name: Configure AWS credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws sts get-caller-identity >/dev/null

      - name: Deploy static assets to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          aws s3 sync packages/client/dist/ "s3://${S3_BUCKET}/" \
            --delete \
            --cache-control "max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "*.json" \
            --exclude "*.txt"

      - name: Upload index.html with no-cache
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          aws s3 cp packages/client/dist/index.html "s3://${S3_BUCKET}/index.html" \
            --cache-control "no-cache,no-store,must-revalidate"

      - name: Upload manifest/text files with no-cache
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          shopt -s nullglob
          for f in packages/client/dist/*.json packages/client/dist/*.txt; do
            aws s3 cp "$f" "s3://${S3_BUCKET}/$(basename "$f")" \
              --cache-control "no-cache,no-store,must-revalidate"
          done

      - name: Invalidate CloudFront cache
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DISTRIBUTION_ID}" \
            --paths "/*"
